{{- /* Extract FAQ from content with Q: format */ -}}
{{- $content := .RawContent -}}
{{- $faqs := slice -}}

{{- /* Split content by Q: pattern to find questions */ -}}
{{- $lines := split $content "\n" -}}
{{- $currentQ := "" -}}
{{- $currentA := "" -}}
{{- $inAnswer := false -}}

{{- range $lines -}}
  {{- $line := trim . " \n\r" -}}
  
  {{- /* Check if line contains a question (Q: or ### Q:) */ -}}
  {{- if or (hasPrefix $line "## Q:") (hasPrefix $line "### Q:") -}}
    {{- /* Save previous Q&A if exists */ -}}
    {{- if and $currentQ $currentA -}}
      {{- $faqs = $faqs | append (dict "question" $currentQ "answer" $currentA) -}}
    {{- end -}}
    
    {{- /* Extract new question (remove ## or ### and Q: prefix) */ -}}
    {{- $currentQ = replaceRE `^##+ Q:\s*` "" $line -}}
    {{- $currentA = "" -}}
    {{- $inAnswer = false -}}
  {{- else if hasPrefix $line "A:" -}}
    {{- /* Start collecting answer */ -}}
    {{- $currentA = replaceRE `^A:\s*` "" $line -}}
    {{- $inAnswer = true -}}
  {{- else if and $inAnswer (ne $line "") (not (hasPrefix $line "#")) -}}
    {{- /* Continue collecting answer lines */ -}}
    {{- if $currentA -}}
      {{- $currentA = printf "%s %s" $currentA $line -}}
    {{- else -}}
      {{- $currentA = $line -}}
    {{- end -}}
  {{- else if or (hasPrefix $line "##") (eq $line "--") -}}
    {{- /* Stop collecting answer at next heading or separator */ -}}
    {{- $inAnswer = false -}}
  {{- end -}}
{{- end -}}

{{- /* Save last Q&A */ -}}
{{- if and $currentQ $currentA -}}
  {{- $faqs = $faqs | append (dict "question" $currentQ "answer" $currentA) -}}
{{- end -}}

{{- /* Output FAQ Schema if we have questions */ -}}
{{- if gt (len $faqs) 0 -}}
<!-- FAQ Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {{- range $index, $faq := $faqs -}}
    {{- if $index -}},{{ end }}
    {
      "@type": "Question",
      "name": {{ $faq.question | plainify | jsonify }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {{ $faq.answer | plainify | truncate 500 | jsonify }}
      }
    }
    {{- end -}}
  ]
}
</script>
{{- end -}}
